const state={questions:[],lessons:[],modules:[],selectedQuestion:null,selectedLessonId:null,statusTimer:null,initialLessonId:parseInt(window.ADMIN_CONFIG.lessonId??0,10)||0},LANGUAGE_LABELS={EN:"English",RU:"Russian",PT:"Portuguese",FR:"French"};function populateQuestionForm(e){document.getElementById("questionDb").value=e.db||"sakila",document.getElementById("questionDbTemplate").value=e.db_template||"sakila",document.getElementById("questionSolution").value=e.solution_query||"",document.getElementById("questionMatch").value=e.query_match||"",document.getElementById("questionNotMatch").value=e.query_not_match||"",document.getElementById("questionResult").value=e.query_valid_result||"";const t=e.localizations||{},n=t.en||{},o=t.ru||{};document.getElementById("questionTitleEn").value=n.title||"",document.getElementById("questionTaskEn").value=n.task||"",document.getElementById("questionHintEn").value=n.hint||"",document.getElementById("questionTitleRu").value=o.title||"",document.getElementById("questionTaskRu").value=o.task||"",document.getElementById("questionHintRu").value=o.hint||"";const s={};(e.query_checks||[]).forEach(e=>{s[e.id]=Boolean(e.checked)}),document.querySelectorAll("[data-query-check-row]").forEach(e=>{const t=e.querySelector('input[type="checkbox"]');if(!t)return;const n=e.dataset.checkId;t.checked=Boolean(s[n])});const a={};(e.categories||[]).forEach(e=>{e.category_id&&(a[e.category_id]=Boolean(e.checked))}),document.querySelectorAll("[data-question-category-row]").forEach(e=>{const t=e.querySelector('input[type="checkbox"]');if(!t)return;const n=e.dataset.categoryId;t.checked=Boolean(a[n])})}function clearQuestionForm(){document.getElementById("questionForm").reset(),state.selectedQuestion=null,document.querySelectorAll('[data-query-check-row] input[type="checkbox"]').forEach(e=>{e.checked=!1}),document.querySelectorAll('[data-question-category-row] input[type="checkbox"]').forEach(e=>{e.checked=!1})}function gatherQuestionPayload(){const e={};document.querySelectorAll('[data-query-check-row] input[type="checkbox"]').forEach(t=>{const n=t.closest("[data-query-check-row]");n?.dataset.checkId&&(e[n.dataset.checkId]=t.checked)});const t={};return document.querySelectorAll('[data-question-category-row] input[type="checkbox"]').forEach(e=>{const n=e.closest("[data-question-category-row]");n?.dataset.categoryId&&(t[n.dataset.categoryId]=e.checked)}),{db:document.getElementById("questionDb").value.trim()||"sakila",db_template:document.getElementById("questionDbTemplate").value.trim()||"sakila",solution_query:document.getElementById("questionSolution").value.trim(),query_checks:e,categories:t,query_match:document.getElementById("questionMatch").value.trim(),query_not_match:document.getElementById("questionNotMatch").value.trim(),query_valid_result:document.getElementById("questionResult").value.trim(),query_pre_check:document.getElementById("questionPreCheck").value.trim(),query_check:document.getElementById("questionCheck").value.trim(),localizations:{en:{title:document.getElementById("questionTitleEn").value.trim(),task:document.getElementById("questionTaskEn").value.trim(),hint:document.getElementById("questionHintEn").value.trim()},ru:{title:document.getElementById("questionTitleRu").value.trim(),task:document.getElementById("questionTaskRu").value.trim(),hint:document.getElementById("questionHintRu").value.trim()}}}}async function saveQuestion(){try{const e=gatherQuestionPayload(),t=state.selectedQuestion?"PUT":"POST",n=state.selectedQuestion?`/admin/question/${state.selectedQuestion.id}`:"/admin/question",o=await safeFetch(n,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});state.selectedQuestion=o.question,populateQuestionForm(state.selectedQuestion),updateSelectedQuestionLabel(),showStatus("Question saved","success"),loadQuestions()}catch(e){console.error(e)}}async function deleteQuestion(){if(state.selectedQuestion){if(confirm("Delete this question?"))try{await safeFetch(`/admin/question/${state.selectedQuestion.id}`,{method:"DELETE"}),showStatus("Question removed","success"),state.selectedQuestion=null,clearQuestionForm(),updateSelectedQuestionLabel(),loadQuestions()}catch(e){console.error(e)}}else showStatus("Select a question before deleting","info")}function updateSelectedQuestionLabel(){const e=document.getElementById("selectedQuestionLabel");state.selectedQuestion?e.textContent=`Editing question #${state.selectedQuestion.id}`:e.textContent="No question selected"}function populateModuleSelect(){const e=document.getElementById("lessonModule");e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="Choose module",t.disabled=!0,t.selected=!0,e.appendChild(t),state.modules.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.title,e.appendChild(n)})}async function selectLesson(e){try{const t=await safeFetch(`/admin/lesson/${e}`);state.selectedLessonId=e,populateLessonForm(t.lesson),updateSelectedLessonLabel(),renderLessonList()}catch(e){console.error(e)}}function populateLessonForm(e){document.getElementById("lessonModule").value=e.module_id,document.getElementById("lessonTitleEn").value=e.localizations?.en?.title||"",document.getElementById("lessonDescriptionEn").value=e.localizations?.en?.description||"",document.getElementById("lessonContentEn").value=e.localizations?.en?.content||"",document.getElementById("lessonTitleRu").value=e.localizations?.ru?.title||"",document.getElementById("lessonDescriptionRu").value=e.localizations?.ru?.description||"",document.getElementById("lessonContentRu").value=e.localizations?.ru?.content||""}function clearLessonForm(){document.getElementById("lessonForm").reset(),state.selectedLessonId=null}function gatherLessonPayload(){return{module_id:parseInt(document.getElementById("lessonModule").value,10)||0,localizations:{en:{title:document.getElementById("lessonTitleEn").value.trim(),description:document.getElementById("lessonDescriptionEn").value.trim(),content:document.getElementById("lessonContentEn").value.trim()},ru:{title:document.getElementById("lessonTitleRu").value.trim(),description:document.getElementById("lessonDescriptionRu").value.trim(),content:document.getElementById("lessonContentRu").value.trim()}}}}async function saveLesson(){try{const e=gatherLessonPayload(),t=state.selectedLessonId?"PUT":"POST",n=state.selectedLessonId?`/admin/lesson/${state.selectedLessonId}`:"/admin/lesson",o=await safeFetch(n,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});state.selectedLessonId=o.lesson.id,populateLessonForm(o.lesson),updateSelectedLessonLabel(),showStatus("Lesson saved","success"),loadLessons()}catch(e){console.error(e)}}async function deleteLesson(){if(state.selectedLessonId){if(confirm("Delete this lesson?"))try{await safeFetch(`/admin/lesson/${state.selectedLessonId}`,{method:"DELETE"}),showStatus("Lesson removed","success"),state.selectedLessonId=null,clearLessonForm(),updateSelectedLessonLabel(),loadLessons()}catch(e){console.error(e)}}else showStatus("Select a lesson before deleting","info")}function updateSelectedLessonLabel(){const e=document.getElementById("selectedLessonLabel");state.selectedLessonId?e.textContent=`Editing lesson #${state.selectedLessonId}`:e.textContent="No lesson selected"}function handleTranslateClick(e){const t=e.target.closest("[data-translate]");if(!t)return;const n=document.getElementById(t.dataset.source),o=document.getElementById(t.dataset.target),s=t.dataset.from||"English",a=t.dataset.to||"Russian";n&&o&&translateField(n.value,s,a).then(e=>{o.value=e,showStatus(`Translated to ${a}`,"success")}).catch(()=>{})}async function translateField(e,t,n){if(!e.trim())throw new Error("Provide text to translate first");const{result:o}=await safeFetch("/admin/llm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task:"translate",from_lang:t,to_lang:n,text:e})});return o||""}function updateLLMOptions(){}async function questionReview(e){const t=(e||"").toUpperCase();if(!t)return void showStatus("Language is required","error");const n=`Review this question:\n\n        Title: ${document.getElementById(`questionTitle${t}`).value.trim()}\n        Task: ${document.getElementById(`questionTask${t}`).value.trim()}\n        Hint: ${document.getElementById(`questionHint${t}`).value.trim()}\n        Solution query:  ${document.getElementById("questionSolution").value.trim()}\n        \n        Return answer in language ${LANGUAGE_LABELS[t]||t}\n        `;response=await runLLM("question-review",n,LANGUAGE_LABELS[t]),document.getElementById(`questionLLMResult${t}`).innerHTML=response}async function questionTranslateTo(e){const t=(e||"").toUpperCase();if(!t)return void showStatus("Language is required","error");const n=document.getElementById(`translate${t}ToLang`)?.value.trim()||"",o=document.getElementById(`questionTitle${t}`)?.value.trim(),s=document.getElementById(`questionTask${t}`)?.value.trim(),a=document.getElementById(`questionHint${t}`)?.value.trim();if(!o||!s||!a)return void showStatus("Provide title, task, and hint in Source language before translating.","info");const l=`Title: ${o}\nTask: ${s}\nHint: ${a}`.trim();try{const t=await translateField(l,e,n),o=document.getElementById(`questionLLMResult${n.toUpperCase()}`);o&&(o.innerHTML=t.replace(/\n/g,"<br>"))}catch(e){console.error(e)}}async function questionLocalizationSave(e,t){const n=parseInt(e,10);if(!n)return void showStatus("Save the question before saving a localization.","info");const o=(t||"").toUpperCase();if(!o)return void showStatus("Language is required","error");const s=document.getElementById(`questionTitle${o}`)?.value.trim(),a=document.getElementById(`questionTask${o}`)?.value.trim(),l=document.getElementById(`questionHint${o}`)?.value.trim();if(!s||!a||!l||""===s||""===a||""===l)return void showStatus("All fields are required","error");const c={question_id:n,language:o,title:s,task:a,hint:l};try{await safeFetch("/admin/question-localization",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})}catch(e){console.error(e)}}function collectQuestionCheckStates(){const e=[];return document.querySelectorAll("[data-query-check-row]").forEach(t=>{const n=t.querySelector('input[type="checkbox"]'),o=t.dataset.checkId;n&&o&&n.checked&&e.push(parseInt(o,10))}),e}async function questionChecksSave(e){const t=parseInt(e,10);if(!t)return void showStatus("Save the question before toggling query checks.","info");const n=collectQuestionCheckStates();try{console.log("Saving question checks for question",t,n);const e=await safeFetch("/admin/question-checks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question_id:t,checks:n})});e.ok?showStatus("Query checks saved","success"):(console.error("Failed to save query checks",e),showStatus("Failed to save query checks","error"))}catch(e){console.error(e)}}async function runLLM(e,t,n="English"){const o={task:e,language:n};console.log(`Running LLM task: ${e} with input:`,t),"translate"===e?(o.text=t,o.from_lang=document.getElementById("llmFromLang").value.trim()||"English",o.to_lang=document.getElementById("llmToLang").value.trim()||"Russian"):(o.context={question:t},o.style="clear and concise");try{return(await safeFetch("/admin/llm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).result||"No response"}catch(e){console.error(e)}}async function safeFetch(e,t={}){try{const n={Accept:"application/json",...t.headers||{}},o=await fetch(e,{...t,headers:n}),s=await o.json();if(!o.ok){const e=s.error||"Something went wrong";throw showStatus(e,"error"),new Error(e)}return s}catch(e){throw e.message||showStatus("Network error","error"),e}}function showStatus(e,t="info"){const n=document.getElementById("statusBar");n.textContent=e,n.dataset.status=t,n.classList.add("is-visible"),clearTimeout(state.statusTimer),state.statusTimer=setTimeout(()=>n.classList.remove("is-visible"),4500)}
//# sourceMappingURL=script.min.js.map